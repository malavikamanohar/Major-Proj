{% extends 'diagnosis/base.html' %}

{% block title %}Patient Details - {{ patient.patient_id }}{% endblock %}

{% block content %}
<div class="card">
    <h1 class="card-header">Patient: {{ patient.patient_id }}</h1>
    
    <div class="grid grid-3" style="margin-bottom: 2rem;">
        <div>
            <p><strong>Age:</strong> {{ patient.age }} years</p>
            <p><strong>Sex:</strong> {{ patient.get_sex_display }}</p>
        </div>
        <div>
            <p><strong>Created:</strong> {{ patient.created_at|date:"M d, Y H:i" }}</p>
            <p><strong>Last Updated:</strong> {{ patient.updated_at|date:"M d, Y H:i" }}</p>
        </div>
        <div>
            {% if diagnosis_history %}
            <a href="{% url 'generate_diagnosis' patient.patient_id %}" class="btn btn-primary">Generate New Diagnosis</a>
            {% endif %}
        </div>
    </div>
</div>

<div class="card">
    <h2 class="card-header">Clinical Information</h2>
    <div class="grid grid-2">
        <div>
            <h3 style="color: var(--secondary); margin-bottom: 0.5rem;">Chief Complaint</h3>
            <p style="color: var(--text-muted);">{{ patient.chief_complaint }}</p>
        </div>
        <div>
            <h3 style="color: var(--secondary); margin-bottom: 0.5rem;">Symptoms</h3>
            <p style="color: var(--text-muted);">{{ patient.symptoms }}</p>
        </div>
    </div>
    
    {% if patient.past_medical_history %}
    <div style="margin-top: 1.5rem;">
        <h3 style="color: var(--secondary); margin-bottom: 0.5rem;">Past Medical History</h3>
        <p style="color: var(--text-muted);">{{ patient.past_medical_history }}</p>
    </div>
    {% endif %}
    
    {% if patient.medications %}
    <div style="margin-top: 1.5rem;">
        <h3 style="color: var(--secondary); margin-bottom: 0.5rem;">Current Medications</h3>
        <p style="color: var(--text-muted);">{{ patient.medications }}</p>
    </div>
    {% endif %}
    
    {% if patient.clinical_notes %}
    <div style="margin-top: 1.5rem;">
        <h3 style="color: var(--secondary); margin-bottom: 0.5rem;">Clinical Notes</h3>
        <p style="color: var(--text-muted);">{{ patient.clinical_notes }}</p>
    </div>
    {% endif %}
</div>

{% if vitals %}
<div class="card">
    <h2 class="card-header">Vital Signs</h2>
    <div class="grid grid-3">
        {% if vitals.blood_pressure_systolic and vitals.blood_pressure_diastolic %}
        <div>
            <h3 style="color: var(--secondary); margin-bottom: 0.5rem;">Blood Pressure</h3>
            <p style="font-size: 1.5rem; font-weight: 700;">{{ vitals.blood_pressure_systolic }}/{{ vitals.blood_pressure_diastolic }}</p>
            <p style="color: var(--text-muted); font-size: 0.875rem;">mmHg</p>
        </div>
        {% endif %}
        
        {% if vitals.heart_rate %}
        <div>
            <h3 style="color: var(--secondary); margin-bottom: 0.5rem;">Heart Rate</h3>
            <p style="font-size: 1.5rem; font-weight: 700;">{{ vitals.heart_rate }}</p>
            <p style="color: var(--text-muted); font-size: 0.875rem;">bpm</p>
        </div>
        {% endif %}
        
        {% if vitals.respiratory_rate %}
        <div>
            <h3 style="color: var(--secondary); margin-bottom: 0.5rem;">Respiratory Rate</h3>
            <p style="font-size: 1.5rem; font-weight: 700;">{{ vitals.respiratory_rate }}</p>
            <p style="color: var(--text-muted); font-size: 0.875rem;">breaths/min</p>
        </div>
        {% endif %}
        
        {% if vitals.oxygen_saturation %}
        <div>
            <h3 style="color: var(--secondary); margin-bottom: 0.5rem;">Oxygen Saturation</h3>
            <p style="font-size: 1.5rem; font-weight: 700;">{{ vitals.oxygen_saturation }}%</p>
            <p style="color: var(--text-muted); font-size: 0.875rem;">SpO2</p>
        </div>
        {% endif %}
        
        {% if vitals.temperature %}
        <div>
            <h3 style="color: var(--secondary); margin-bottom: 0.5rem;">Temperature</h3>
            <p style="font-size: 1.5rem; font-weight: 700;">{{ vitals.temperature }}</p>
            <p style="color: var(--text-muted); font-size: 0.875rem;">Â°F</p>
        </div>
        {% endif %}
    </div>
    <p style="color: var(--text-muted); font-size: 0.875rem; margin-top: 1rem;">
        Recorded: {{ vitals.recorded_at|date:"M d, Y H:i" }}
    </p>
</div>
{% endif %}

{% if labs %}
<div class="card">
    <h2 class="card-header">Laboratory Results</h2>
    <div style="background: rgba(0, 0, 0, 0.2); padding: 1.5rem; border-radius: 10px; font-family: monospace; white-space: pre-wrap;">{{ labs.lab_results }}</div>
    <p style="color: var(--text-muted); font-size: 0.875rem; margin-top: 1rem;">
        Recorded: {{ labs.recorded_at|date:"M d, Y H:i" }}
    </p>
</div>
{% endif %}

{% if clinical_summary %}
<div class="card">
    <h2 class="card-header">Clinical Summary</h2>
    <div style="background: rgba(0, 0, 0, 0.2); padding: 1.5rem; border-radius: 10px; font-family: monospace; white-space: pre-wrap;">{{ clinical_summary.summary_text }}</div>
    <p style="color: var(--text-muted); font-size: 0.875rem; margin-top: 1rem;">
        Generated: {{ clinical_summary.created_at|date:"M d, Y H:i" }}
    </p>
</div>
{% endif %}

{% if diagnosis_history %}
<div class="card">
    <h2 class="card-header">Diagnosis History</h2>
    <table class="table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Triage Level</th>
                <th>Top Diagnosis</th>
                <th>Confidence</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for dx in diagnosis_history %}
            <tr>
                <td>{{ dx.created_at|date:"M d, Y H:i" }}</td>
                <td><span class="badge badge-{{ dx.triage_level|lower }}">{{ dx.triage_level }}</span></td>
                <td>
                    {% if dx.differential_diagnoses %}
                        {{ dx.differential_diagnoses.0.diagnosis|default:"N/A" }}
                    {% else %}
                        N/A
                    {% endif %}
                </td>
                <td>{{ dx.confidence_score|floatformat:2 }}</td>
                <td>
                    <a href="{% url 'diagnosis_result' dx.id %}" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">View Details</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="card" style="text-align: center;">
    <h2 class="card-header">No Diagnosis Yet</h2>
    <p style="color: var(--text-muted); margin-bottom: 2rem;">
        Generate a diagnosis for this patient using the RAG system.
    </p>
    <a href="{% url 'generate_diagnosis' patient.patient_id %}" class="btn btn-primary">Generate Diagnosis</a>
</div>
{% endif %}

{% if job_history %}
<div class="card">
    <h2 class="card-header">Diagnosis Jobs</h2>
    <table class="table">
        <thead>
            <tr>
                <th>Created</th>
                <th>Status</th>
                <th>Linked Diagnosis</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for job in job_history %}
            <tr>
                <td>{{ job.created_at|date:"M d, Y H:i" }}</td>
                <td>
                    <span class="badge
                        {% if job.status == 'COMPLETED' %}badge-low
                        {% elif job.status == 'FAILED' %}badge-critical
                        {% elif job.status == 'PROCESSING' %}badge-high
                        {% else %}badge-moderate{% endif %}">
                        {{ job.get_status_display }}
                    </span>
                </td>
                <td>
                    {% if job.diagnosis %}
                        {{ job.diagnosis.created_at|date:"M d, Y H:i" }}
                    {% else %}
                        --
                    {% endif %}
                </td>
                <td>
                    {% if job.diagnosis %}
                        <a href="{% url 'diagnosis_result' job.diagnosis.id %}" class="btn btn-secondary" style="padding: 0.4rem 1rem; font-size: 0.85rem;">View Result</a>
                    {% else %}
                        <a href="{% url 'diagnosis_job_detail' job.id %}" class="btn btn-secondary" style="padding: 0.4rem 1rem; font-size: 0.85rem;">View Status</a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<div style="margin-top: 2rem;">
    <a href="{% url 'patient_list' %}" class="btn btn-secondary">Back to Patient List</a>
</div>
{% endblock %}
